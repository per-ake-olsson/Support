name: Generate PDFs for Markdown

on:
  push:
    branches:
      - main
    paths:
      - 'PwdGen/Win/Swe/downloads/**/*.md'
  workflow_dispatch:

jobs:
  md_to_pdf:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pandoc and LaTeX
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-latex-base texlive-fonts-recommended texlive-latex-extra

      - name: Generate PDFs
        id: generate
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            mapfile -t files < <(find PwdGen/Win/Swe/downloads -maxdepth 1 -name '*.md' -print)
          else
            mapfile -t files < <(git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" -- 'PwdGen/Win/Swe/downloads/*.md')
          fi

          if [ ${#files[@]} -eq 0 ]; then
            echo "No Markdown files to convert."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          for file in "${files[@]}"; do
            echo "Converting ${file}"
            pandoc "${file}" -o "${file%.md}.pdf" -V geometry:top=20mm -V geometry:left=15mm -V geometry:right=15mm -V geometry:bottom=20mm

          done

          # Kontrollera om några PDF-filer har lagts till eller ändrats
          if git status --porcelain | grep -q '.pdf$'; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit generated PDFs
        if: steps.generate.outputs.changed == 'true'
        uses: EndBug/add-and-commit@v9
        with:
          add: 'PwdGen/Win/Swe/downloads/*.pdf'
          message: 'chore: auto-generate PDF for updated manuals'
          default_author: github_actions
